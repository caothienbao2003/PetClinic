@page
@model PetClinic.Pages.BookingManagement.ChooseDateShiftDoctorModel
@{
    Layout = null;
    ViewData["Title"] = "Choose Date Shift Doctor Page";

    var userId = HttpContext.Session.GetString("UserId");
    var role = HttpContext.Session.GetString("Role");
    var email = HttpContext.Session.GetString("Email");

    if (userId == null || role != "0")
    {
        Response.Redirect("/Authentication/Login");
    }
}

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pet Clinic Homepage</title>
    <link rel="stylesheet" href="~/css/luongstyle.css" />
    <link rel="stylesheet" href="~/css/chooseDateShiftDoctor.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha384-jLKHWMd+18JsE0ASdP9D1EF/CVt/8Kv8G2xfMbS4kTF+AI9uF27WQ/MI00L8HIy8" crossorigin="anonymous">
</head>

<header>
    <h1>Pet Clinic</h1>
</header>

<nav class="navbar navbar-expand-sm">
    <a asp-page="/Customer/CustomerHomePage">Home</a>
    <a asp-page="/Customer/BookingManagement/BookingHistory">View Bookings</a>
    <a asp-page="/Customer/PetManagement/Index">My Pets</a>
    <a asp-page="/Customer/PetHealthManagement/Index">Pet Healths</a>
    <a asp-page="/VaccinationManagement/Index">Vaccinations</a>
    <a asp-page="/Customer/HospitalizationView/HospitalizationView">Hospitalizations</a>
</nav>

<div class="booking-container">
    <div class="calendar-container">
        <h1 class="booking-header">Booking</h1>
        <h2>Choose a date</h2>
        <form method="post" asp-page-handler="ChangeMonth">
            <div class="navigation-buttons">
                <button type="submit" name="offset" value="-1" class="btn-transparent @(Model.CurrentMonth == DateTime.Today.Month && Model.CurrentYear == DateTime.Today.Year ? "disabled" : "")" @(Model.CurrentMonth == DateTime.Today.Month && Model.CurrentYear == DateTime.Today.Year ? "disabled" : "")>
                    Prev
                </button>
                <div class="month-year-wrapper">
                    <span id="monthYearDisplay">@Model.CurrentMonthYearDisplay</span>
                </div>
                <button type="submit" name="offset" value="1" class="btn-transparent">
                    Next
                </button>
            </div>

            <input type="hidden" asp-for="SelectedShiftId" value="@Model.SelectedShiftId" />
            <input type="hidden" name="currentMonth" value="@Model.CurrentMonth" />
            <input type="hidden" name="currentYear" value="@Model.CurrentYear" />
            <input type="hidden" name="selectedDate" value="@Model.SelectedDate" />
            <input type="hidden" asp-for="SelectedPetId" value="@Model.SelectedPetId" />

        </form>

        <table class="calendar">
            <thead>
                <tr>
                    <th>Su</th>
                    <th>Mo</th>
                    <th>Tu</th>
                    <th>We</th>
                    <th>Th</th>
                    <th>Fr</th>
                    <th>Sa</th>
                </tr>
            </thead>
            <tbody id="calendarBody">
                <form method="post" asp-page-handler="ChooseDate">
                    @{
                        int sundayIndex = 7;
                        var cellList = Model.CalendarCellList;

                        for (int i = 0; i < cellList.Count; i++)
                        {
                            if (i % 7 == 0)
                            {
                            <tr>
                                    @for (int j = i; j < sundayIndex; j++)
                                    {
                                    <td>
                                        <button type="submit" name="date" value="@cellList[j].Date" class="btn-cell @(cellList[j].IsAvailable ? "available-date" : "unavailable-date") @(cellList[j].IsSelected ? "selected-date" : "")" @(cellList[j].IsAvailable ? "" : "disabled")>
                                                @(cellList[j].Date?.Day.ToString())
                                        </button>
                                    </td>
                                    }
                                    @{
                                        sundayIndex += 7;
                                    }
                            </tr>
                            }
                        }
                    }
                <input type="hidden" asp-for="SelectedPetId" value="@Model.SelectedPetId" />

                </form>
            </tbody>
        </table>
        <div class="selected-date-info">
            Date selected: @Model.SelectedDate?.ToString("dd/MM/yyyy")
        </div>


        <div class="form-group text-center">
            <a asp-page="ChoosePet" class="back-link"><i class="fas fa-arrow-left"></i> Back to Choose Pet</a>
        </div>
    </div>

    <div class="details-container">
        @if (Model.ShiftSelectionList != null && Model.ShiftSelectionList.Count > 0 && Model.SelectedDate != null)
        {
            <form method="post" asp-page-handler="ChooseShift">
                <h2>Available slots</h2>
                <div class="shifts-container">
                    @foreach (var shift in Model.ShiftSelectionList)
                    {
                        <div>
                            <button type="submit" name="shiftId" value="@shift.ShiftId" class="shift @(shift.IsAvailable ? "" : "unavailable") @(shift.IsSelected ? "selected" : "")" @(shift.IsAvailable ? "" : "disabled")>
                                @shift.ShiftDisplay
                                <br />
                                @shift.OccupationDisplay
                            </button>
                        </div>

                        <input type="hidden" asp-for="CurrentMonth" value="@Model.CurrentMonth" />
                        <input type="hidden" asp-for="CurrentYear" value="@Model.CurrentYear" />
                        <input type="hidden" asp-for="SelectedDate" value="@Model.SelectedDate" />
                        <input type="hidden" asp-for="SelectedPetId" value="@Model.SelectedPetId" />
                    }
                </div>
            </form>
        }
        @if (Model.DoctorSelectionList != null && Model.DoctorSelectionList.Count > 0)
        {
            <h2>Available Doctors</h2>
            <form method="post" asp-page-handler="ChooseDoctor">
                <div class="doctors-container">
                    @foreach (var doctor in Model.DoctorSelectionList)
                    {
                        <div>
                            <button type="submit" name="doctorId" value="@doctor.DoctorId" class="doctor @(doctor.IsAvailable ? "" : "unavailable") @(doctor.IsSelected ? "selected" : "")" @(doctor.IsAvailable ? "" : "disabled")>
                                @doctor.DoctorName
                            </button>
                        </div>

                        <input type="hidden" asp-for="SelectedShiftId" value="@Model.SelectedShiftId" />
                        <input type="hidden" asp-for="CurrentMonth" value="@Model.CurrentMonth" />
                        <input type="hidden" asp-for="CurrentYear" value="@Model.CurrentYear" />
                        <input type="hidden" asp-for="SelectedDate" value="@Model.SelectedDate" />
                        <input type="hidden" asp-for="SelectedPetId" value="@Model.SelectedPetId" />

                    }
                </div>
            </form>
        }

        @if (Model.DoctorSelectionList != null && Model.DoctorSelectionList.Count > 0)
        {
            <div class="form-group text-center">
                <form method="post" asp-page-handler="Next">
                    <input type="hidden" asp-for="SelectedDate" value="@Model.SelectedDate" />
                    <input type="hidden" asp-for="SelectedShiftId" value="@Model.SelectedShiftId" />
                    <input type="hidden" asp-for="SelectedDoctorId" value="@Model.SelectedDoctorId" />
                    <input type="hidden" asp-for="SelectedPetId" value="@Model.SelectedPetId" />
                    <input type="hidden" asp-for="CurrentMonth" value="@Model.CurrentMonth" />
                    <input type="hidden" asp-for="CurrentYear" value="@Model.CurrentYear" />

                    <input type="submit" value="Next" class="btn btn-primary" />
                </form>
            </div>
        }

        @if (Model.Error != null)
        {
            <div class="alert alert-danger" role="alert">
                @Model.Error
            </div>
        }
    </div>
</div>