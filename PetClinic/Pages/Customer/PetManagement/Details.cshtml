@page
@model PetClinic.Pages.Customer.PetManagement.DetailsModel
@{
    Layout = null;
    ViewData["Title"] = "Pet Management Details Page";

    var userId = HttpContext.Session.GetString("UserId");
    var role = HttpContext.Session.GetString("Role");

    if (userId == null || role != "0")
    {
        Response.Redirect("/Authentication/Login");
    }
}

<style>
    .container {
        margin: 0 auto;
        padding: 20px;
        max-width: 800px;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

        .table th, .table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .table th {
            background-color: green;
            color: white;
        }

        .table td {
            background-color: #f9f9f9;
        }

        .table tr:nth-child(even) td {
            background-color: #e9e9e9;
        }

    .btn {
        padding: 5px 10px;
        margin: 2px;
    }

    .btn-info {
        background-color: green;
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }
</style>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pet Clinic Homepage</title>
    <link rel="stylesheet" href="~/css/luongstyle.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" />
</head>

<header>
    <h4>Pet Clinic</h4>
</header>

<nav class="navbar navbar-expand-sm">
    <a asp-page="/Customer/CustomerHomePage">Home</a>
    <a asp-page="/Customer/BookingManagement/BookingHistory">View Bookings</a>
    <a asp-page="/PetManagement/Index">My Pets</a>
    <a asp-page="/Customer/HospitalizationView/HospitalizationView">Hospitalizations</a>
</nav>

<div class="user-info">
    <span>Welcome, @Model.user.FirstName @Model.user.LastName!</span>
    <a asp-page="/Customer/CustomerProfile" class="btn btn-primary">View Profile</a>
    <a asp-page="/Authentication/Logout" class="btn btn-primary">Logout</a>
</div>

<h1 align="center">Pet Health Details</h1>

<body>
    <div class="container">
        <h2 align="center">PET INFORMATION</h2>

        <form method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Pet Details -->
            <div class="form-group">
                <label asp-for="Pet.PetName" class="control-label">Pet Name</label>
                <input type="text" class="form-control" value="@Model.Pet.PetName" readonly />
            </div>
            <div class="form-group">
                <label asp-for="Pet.PetAge" class="control-label">Age</label>
                <input type="text" class="form-control" value="@Model.Pet.PetAge" readonly />
            </div>
            <div class="form-group">
                <label asp-for="Pet.PetType" class="control-label">Type</label>
                <input type="text" class="form-control" value="@Model.Pet.PetType" readonly />
            </div>

            <!-- Pet Health Information -->
            <div class="form-group">
                <label asp-for="PetHealth.Conditions" class="control-label">Conditions</label>
                <input type="text" class="form-control" value="@Model.PetHealth.Conditions" readonly />
            </div>
            <div class="form-group">
                <label asp-for="PetHealth.Weight" class="control-label">Weight(kg)</label>
                <input type="text" class="form-control" value="@Model.PetHealth.Weight" readonly />
            </div>
            <div class="form-group">
                <label asp-for="PetHealth.WeightMeasurementDate" class="control-label">Weight Measurement Date</label>
                <input type="text" class="form-control" value="@Model.PetHealth.WeightMeasurementDate" readonly />
            </div>
            <div class="form-group">
                <label asp-for="PetHealth.OverallHealth" class="control-label">Overall Health</label>
                <input type="text" class="form-control" value="@Model.PetHealth.OverallHealth" readonly />
            </div>

            <!-- Vaccination Record -->
            <h3>Vaccination Record</h3>
            @if (Model.PetHealth != null && Model.VaccinationRecordList != null && Model.VaccinationRecordList.Count > 0)
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Vaccination Record ID</th>
                            <th>Vaccination Date</th>
                            <th>Next Due Date</th>
                            <th>Vaccinated At</th>
                            <th>Verification</th>
                            <th>Medicine Name</th>                            
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var record in Model.VaccinationRecordList)
                        {
                            <tr>
                                <td>@record.VaccinationRecordId</td>
                                <td>@record.VaccinationDate</td>
                                <td>@record.NextDueDate</td>
                                <td>@record.VaccinatedAt</td>
                                <td>@record.Verification</td>
                                <td>@record.Medicine.MedicineName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>No vaccination records available.</p>
            }
        </form>

        <!-- Add Vaccination Button -->
        <button type="button" class="btn btn-info" data-toggle="modal" data-target="#addVaccinationModal">
            Add Vaccination Record
        </button>
        <a asp-page="./Index"><button class="btn btn-info">Back to List</button></a>

        <!-- Add Vaccination Modal -->
        <div class="modal fade" id="addVaccinationModal" tabindex="-1" role="dialog" aria-labelledby="addVaccinationModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addVaccinationModalLabel">Add Vaccination Record</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addVaccinationForm" method="post" asp-page-handler="AddVaccination" onsubmit="submitVaccinationRecord(event)">

                            <input type="hidden" name="NewVaccinationRecord.PetHealthId" value="@Model.PetHealth.PetHealthId" />
                            <div class="form-group">
                                <label for="VaccinationDate">Vaccination Date</label>
                                <input type="date" class="form-control" id="VaccinationDate" name="NewVaccinationRecord.VaccinationDate" required />
                            </div>
                            <div class="form-group">
                                <label for="NextDueDate">Next Due Date</label>
                                <input type="date" class="form-control" id="NextDueDate" name="NewVaccinationRecord.NextDueDate" required />
                            </div>
                            <div class="form-group">
                                <label for="VaccinatedAt">Vaccinated At</label>
                                <input type="text" class="form-control" id="VaccinatedAt" name="NewVaccinationRecord.VaccinatedAt" required />
                            </div>
                            <div class="form-group">
                                <label for="MedicineId">Medicine Name</label>
                                <select class="form-control" id="MedicineId" name="NewVaccinationRecord.MedicineId" required>
                                    @foreach (var medicine in Model.MedicineList)
                                    {
                                        <option value="@medicine.MedicineId">@medicine.MedicineName</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="Verification">Verification</label>
                                <select class="form-control" id="Verification" name="NewVaccinationRecord.Verification" required>
                                    @* <option value="true">Verified</option> *@
                                    <option value="false">Not Verified</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Add</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.2/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.11/jquery.validate.unobtrusive.min.js"></script>
<script src="~/js/site.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function submitVaccinationRecord(event) {
            event.preventDefault(); // Prevent the form from submitting the traditional way

            if (!confirm('Are you sure you want to add this vaccination record?')) {
                return;
            }

            const formData = new FormData(document.getElementById('addVaccinationForm'));

            fetch('@Url.Page("Details", "AddVaccination")', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    updateVaccinationRecordsTable(data);
                    $('#addVaccinationModal').modal('hide');
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateVaccinationRecordsTable(data) {
            const tbody = document.querySelector('table tbody');
            tbody.innerHTML = ''; // Clear existing rows
            data.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                            <td>${record.vaccinationRecordId}</td>
                            <td>${record.vaccinationDate}</td>
                            <td>${record.nextDueDate}</td>
                            <td>${record.vaccinatedAt}</td>
                            <td>${record.verification}</td>
                            <td>${record.medicineId}</td>
                        `;
                tbody.appendChild(row);
            });
        }
    </script>
}

